<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>üîí Admin Profissional - Seja Vers√°til</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --bg-light: #f3f4f6;
            --white: #ffffff;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
        }

        /* --- Login Screen --- */
        .login-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex; align-items: center; justify-content: center; z-index: 2000;
        }
        .login-box {
            background: var(--white); padding: 2.5rem; border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 100%; max-width: 400px; text-align: center;
        }
        .login-box h1 { font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--text-dark); }
        
        /* --- Layout Admin --- */
        .admin-container { display: none; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar {
            width: 260px; background: var(--white); border-right: 1px solid var(--border);
            position: fixed; height: 100vh; left: 0; top: 0; display: flex; flex-direction: column;
        }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--border); }
        .sidebar-logo { font-weight: 800; font-size: 1.25rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        .sidebar-menu { padding: 1.5rem 1rem; flex: 1; }
        .menu-item {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem;
            color: var(--text-gray); border-radius: 8px; cursor: pointer; margin-bottom: 0.5rem;
            transition: all 0.2s; font-weight: 500;
        }
        .menu-item:hover, .menu-item.active { background: #e0e7ff; color: var(--primary-dark); }
        .menu-item .material-icons-round { font-size: 1.25rem; }
        
        .sidebar-footer { padding: 1rem; border-top: 1px solid var(--border); }
        .btn-logout {
            width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.75rem; border: 1px solid var(--danger); color: var(--danger);
            border-radius: 8px; background: transparent; cursor: pointer; font-weight: 600;
            transition: all 0.2s;
        }
        .btn-logout:hover { background: #fef2f2; }

        /* Main Content */
        .main-content { margin-left: 260px; padding: 2rem; width: calc(100% - 260px); }
        
        .header-bar {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;
        }
        .page-title { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); }
        
        /* Cards de Stats */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--white); padding: 1.5rem; border-radius: 12px;
            box-shadow: var(--shadow-sm); border: 1px solid var(--border);
            display: flex; align-items: center; gap: 1rem;
        }
        .stat-icon {
            width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
            background: #eff6ff; color: var(--primary);
        }
        .stat-info h3 { font-size: 0.875rem; color: var(--text-gray); font-weight: 500; }
        .stat-info p { font-size: 1.5rem; font-weight: 700; color: var(--text-dark); }

        /* Tabelas */
        .table-container {
            background: var(--white); border-radius: 12px; border: 1px solid var(--border);
            overflow: hidden; box-shadow: var(--shadow-sm);
        }
        .table-actions {
            padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
        }
        table { width: 100%; border-collapse: collapse; }
        th {
            text-align: left; padding: 1rem; background: #f9fafb; color: var(--text-gray);
            font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
        }
        td { padding: 1rem; border-top: 1px solid var(--border); vertical-align: middle; }
        tr:hover { background: #f9fafb; }
        
        .product-thumb {
            width: 48px; height: 48px; border-radius: 8px; object-fit: cover; background: #f3f4f6;
        }
        .badge {
            padding: 0.25rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;
        }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        /* Bot√µes */
        .btn {
            display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1.2rem;
            border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-gray); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

        /* Inputs */
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500; color: var(--text-dark); }
        .form-control {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;
            font-size: 0.95rem; transition: border-color 0.2s;
        }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }

        /* Modais */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px);
        }
        .modal-overlay.active { display: flex; }
        .modal-card {
            background: var(--white); width: 90%; max-width: 800px; max-height: 90vh;
            border-radius: 16px; box-shadow: var(--shadow-lg); overflow-y: auto;
            display: flex; flex-direction: column;
        }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; flex: 1; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 1rem; }

        /* Gerenciador de Imagens */
        .image-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem;
        }
        .image-card {
            position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 2px solid var(--border);
        }
        .image-card img { width: 100%; height: 100%; object-fit: cover; }
        .image-card.cover { border-color: var(--success); }
        .image-card.cover::after {
            content: 'CAPA'; position: absolute; top: 0; left: 0; background: var(--success); color: white;
            font-size: 0.7rem; padding: 2px 6px; font-weight: 700; border-bottom-right-radius: 8px;
        }
        .img-actions {
            position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7);
            display: flex; justify-content: space-between; padding: 5px; opacity: 0; transition: 0.2s;
        }
        .image-card:hover .img-actions { opacity: 1; }
        .icon-btn { background: none; border: none; color: white; cursor: pointer; padding: 4px; }
        .icon-btn:hover { color: var(--primary); }

        /* Loading */
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="login-wrapper" id="loginScreen">
        <div class="login-box">
            <h1>üîí Admin Access</h1>
            <form id="loginForm">
                <div class="input-group">
                    <input type="email" class="form-control" id="loginEmail" placeholder="Email de Administrador" required>
                </div>
                <div class="input-group">
                    <input type="password" class="form-control" id="loginPassword" placeholder="Senha" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                    Entrar no Painel
                </button>
                <p id="loginError" style="color: var(--danger); margin-top: 1rem; display: none;"></p>
            </form>
        </div>
    </div>

    <div class="admin-container" id="adminApp">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span class="material-icons-round">storefront</span> Seja Vers√°til
                </div>
            </div>
            <nav class="sidebar-menu">
                <div class="menu-item active" onclick="switchTab('dashboard')">
                    <span class="material-icons-round">dashboard</span> Dashboard
                </div>
                <div class="menu-item" onclick="switchTab('products')">
                    <span class="material-icons-round">inventory_2</span> Produtos
                </div>
                <div class="menu-item" onclick="switchTab('settings')">
                    <span class="material-icons-round">settings</span> Configura√ß√µes
                </div>
            </nav>
            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">
                    <span class="material-icons-round">logout</span> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <section id="tab-dashboard" class="tab-content">
                <div class="header-bar">
                    <h2 class="page-title">Vis√£o Geral</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-round">inventory</span></div>
                        <div class="stat-info">
                            <h3>Total Produtos</h3>
                            <p id="statsTotalProducts">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-round">attach_money</span></div>
                        <div class="stat-info">
                            <h3>Valor em Estoque</h3>
                            <p id="statsTotalValue">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--warning); background: #fffbeb;">
                            <span class="material-icons-round">warning</span>
                        </div>
                        <div class="stat-info">
                            <h3>Estoque Baixo</h3>
                            <p id="statsLowStock">0</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="tab-products" class="tab-content" style="display: none;">
                <div class="header-bar">
                    <h2 class="page-title">Gerenciar Produtos</h2>
                    <button class="btn btn-primary" onclick="openProductModal()">
                        <span class="material-icons-round">add</span> Novo Produto
                    </button>
                </div>
                
                <div class="table-container">
                    <div class="table-actions">
                        <input type="text" id="searchProduct" class="form-control" style="max-width: 300px;" placeholder="üîç Buscar produto..." oninput="filterProductsTable()">
                    </div>
                    <table id="productsTable">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Categoria</th>
                                <th>Pre√ßo</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="tab-settings" class="tab-content" style="display: none;">
                <div class="header-bar">
                    <h2 class="page-title">Configura√ß√µes da Loja</h2>
                </div>
                <div class="modal-card" style="max-width: 600px; margin: 0;">
                    <div class="modal-body">
                        <div class="input-group">
                            <label>Banner do Topo (Aviso)</label>
                            <input type="text" id="confTopBanner" class="form-control">
                        </div>
                        <div class="input-group">
                            <label>T√≠tulo Principal</label>
                            <input type="text" id="confTitle" class="form-control">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="saveStoreSettings()">Salvar Altera√ß√µes</button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <div class="modal-overlay" id="productModal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 id="modalTitle">Novo Produto</h3>
                <button class="icon-btn" onclick="closeModal('productModal')" style="color: #333;">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="input-group">
                        <label>Nome do Produto</label>
                        <input type="text" id="prodName" class="form-control" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="input-group">
                            <label>Pre√ßo (R$)</label>
                            <input type="number" id="prodPrice" class="form-control" step="0.01" required>
                        </div>
                        <div class="input-group">
                            <label>Pre√ßo Antigo (Opcional)</label>
                            <input type="number" id="prodOldPrice" class="form-control" step="0.01">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Categoria</label>
                        <select id="prodCategory" class="form-control" required>
                            <option value="blusas">Blusas</option>
                            <option value="conjunto calca">Conjunto Cal√ßa</option>
                            <option value="peca unica">Pe√ßa √önica</option>
                            <option value="conjunto short saia">Conjunto Short Saia</option>
                            <option value="conjunto short">Conjunto Short</option>
                        </select>
                    </div>
                    
                    <div class="input-group" style="border-top: 1px solid var(--border); padding-top: 1rem; margin-top: 1rem;">
                        <label>Galeria de Fotos</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('imgUpload').click()">
                                <span class="material-icons-round">cloud_upload</span> Upload
                            </button>
                            <button type="button" class="btn btn-outline btn-sm" onclick="addImageUrl()">
                                <span class="material-icons-round">link</span> Link
                            </button>
                            <input type="file" id="imgUpload" multiple accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
                        </div>
                        <div id="imagesGrid" class="image-grid"></div>
                        <small style="color: var(--text-gray);">A primeira imagem (borda verde) ser√° a capa.</small>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('productModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveProduct()">Salvar Produto</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAJ9-qnEhtiRVKiyF2TZcLgVgq5kLZYxSs",
            authDomain: "seja-versatil.firebaseapp.com",
            projectId: "seja-versatil",
            storageBucket: "seja-versatil.firebasestorage.app",
            messagingSenderId: "102339207381",
            appId: "1:102339207381:web:cbe1192e3550cd5bf0825c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // VARI√ÅVEIS GLOBAIS
        let productsData = [];
        let tempImages = [];

        // --- AUTENTICA√á√ÉO ---
        auth.onAuthStateChanged(async user => {
            if (user) {
                const adminDoc = await db.collection('admins').doc(user.uid).get();
                if (adminDoc.exists && adminDoc.data().role === 'admin') {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('adminApp').style.display = 'block';
                    loadData();
                } else {
                    alert('Acesso negado!');
                    auth.signOut();
                }
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('adminApp').style.display = 'none';
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;
            try {
                await auth.signInWithEmailAndPassword(email, pass);
            } catch (err) {
                document.getElementById('loginError').textContent = 'Login falhou: ' + err.message;
                document.getElementById('loginError').style.display = 'block';
            }
        });

        function logout() { auth.signOut(); }

        // --- SISTEMA DE ABAS ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).style.display = 'block';
            // Adicionar classe active no menu clicado (l√≥gica simplificada)
        }

        // --- CARREGAR DADOS ---
        async function loadData() {
            const snap = await db.collection('produtos').get();
            productsData = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            renderTable(productsData);
            updateStats();
        }

        function renderTable(data) {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = data.map(p => {
                const img = (p.images && p.images[0]) ? p.images[0] : '';
                const price = p.price ? p.price.toFixed(2) : '0.00';
                return `
                    <tr>
                        <td>
                            <div style="display:flex; align-items:center; gap:1rem;">
                                <img src="${img}" class="product-thumb" onerror="this.src='https://via.placeholder.com/48'">
                                <strong>${p.name}</strong>
                            </div>
                        </td>
                        <td><span class="badge badge-warning">${p.category}</span></td>
                        <td>R$ ${price}</td>
                        <td><span class="badge badge-success">Ativo</span></td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="editProduct('${p.id}')">
                                <span class="material-icons-round" style="font-size:16px;">edit</span>
                            </button>
                            <button class="btn btn-outline btn-sm" style="color:var(--danger); border-color:var(--danger);" onclick="deleteProduct('${p.id}')">
                                <span class="material-icons-round" style="font-size:16px;">delete</span>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStats() {
            document.getElementById('statsTotalProducts').innerText = productsData.length;
            const totalVal = productsData.reduce((sum, p) => sum + (p.price || 0), 0);
            document.getElementById('statsTotalValue').innerText = `R$ ${totalVal.toFixed(2)}`;
        }

        function filterProductsTable() {
            const term = document.getElementById('searchProduct').value.toLowerCase();
            const filtered = productsData.filter(p => p.name.toLowerCase().includes(term));
            renderTable(filtered);
        }

        // --- MODAL DE PRODUTO ---
        function openProductModal() {
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('modalTitle').innerText = 'Novo Produto';
            tempImages = [];
            renderImagesGrid();
            document.getElementById('productModal').classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function editProduct(id) {
            const p = productsData.find(x => x.id === id);
            if(!p) return;
            
            document.getElementById('productId').value = p.id;
            document.getElementById('prodName').value = p.name;
            document.getElementById('prodPrice').value = p.price;
            document.getElementById('prodOldPrice').value = p.oldPrice || '';
            document.getElementById('prodCategory').value = p.category;
            document.getElementById('modalTitle').innerText = 'Editar Produto';
            
            tempImages = p.images || (p.image ? [p.image] : []);
            renderImagesGrid();
            document.getElementById('productModal').classList.add('active');
        }

        async function saveProduct() {
            const id = document.getElementById('productId').value;
            const data = {
                name: document.getElementById('prodName').value,
                price: parseFloat(document.getElementById('prodPrice').value),
                oldPrice: parseFloat(document.getElementById('prodOldPrice').value) || null,
                category: document.getElementById('prodCategory').value,
                images: tempImages,
                image: tempImages.length > 0 ? tempImages[0] : null // Mant√©m compatibilidade
            };

            if(id) {
                await db.collection('produtos').doc(id).update(data);
            } else {
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                await db.collection('produtos').add(data);
            }
            
            closeModal('productModal');
            loadData(); // Recarrega tabela
        }

        async function deleteProduct(id) {
            if(confirm('Tem certeza que deseja excluir?')) {
                await db.collection('produtos').doc(id).delete();
                loadData();
            }
        }

        // --- GERENCIADOR DE IMAGENS ---
        function renderImagesGrid() {
            const grid = document.getElementById('imagesGrid');
            grid.innerHTML = tempImages.map((url, idx) => `
                <div class="image-card ${idx === 0 ? 'cover' : ''}">
                    <img src="${url}">
                    <div class="img-actions">
                        <button type="button" class="icon-btn" onclick="setCover(${idx})" title="Virar Capa">‚òÖ</button>
                        <button type="button" class="icon-btn" onclick="removeImage(${idx})" title="Remover">‚úï</button>
                    </div>
                </div>
            `).join('');
        }

        function setCover(index) {
            if(index === 0) return;
            const item = tempImages.splice(index, 1)[0];
            tempImages.unshift(item);
            renderImagesGrid();
        }

        function removeImage(index) {
            tempImages.splice(index, 1);
            renderImagesGrid();
        }

        function addImageUrl() {
            const url = prompt("Cole o link da imagem:");
            if(url) { tempImages.push(url); renderImagesGrid(); }
        }

        async function handleFileUpload(e) {
            const files = e.target.files;
            if(!files.length) return;
            
            for(let file of files) {
                const ref = storage.ref().child(`produtos/${Date.now()}_${file.name}`);
                await ref.put(file);
                const url = await ref.getDownloadURL();
                tempImages.push(url);
            }
            renderImagesGrid();
            e.target.value = '';
        }

        // --- CONFIGURA√á√ïES ---
        function saveStoreSettings() {
            const s = {
                topBanner: document.getElementById('confTopBanner').value,
                title: document.getElementById('confTitle').value
            };
            localStorage.setItem('sejaVersatilSettings', JSON.stringify(s));
            alert('Configura√ß√µes salvas!');
        }

        // Carregar configs salvas
        const savedSettings = JSON.parse(localStorage.getItem('sejaVersatilSettings') || '{}');
        if(savedSettings.topBanner) document.getElementById('confTopBanner').value = savedSettings.topBanner;
        if(savedSettings.title) document.getElementById('confTitle').value = savedSettings.title;

    </script>
</body>
</html>
